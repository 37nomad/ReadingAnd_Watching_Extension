if(!window.__scraperInitialized__){window.__scraperInitialized__=!0;class f{constructor(){console.log("Enhanced Content Scraper with YouTube transcript support initialized")}async extractContent(){const t=window.location.href,e=this.getPageType(t);console.log(`Extracting from: ${e} | ${t}`);const n=this.getTitle();let o="";e==="youtube"?o=await this.getYouTubeContent():o=this.getArticleContent();const r=this.countWords(o);if(r<(e==="youtube"?20:50))return console.log(`Content too short (${r} words), skipping...`),null;const c={url:t,title:n,content:o,wordCount:r,pageType:e,extractedAt:new Date().toISOString(),qualityScore:this.calculateQualityScore(r,n,e)};return console.log("Content extracted:",{title:c.title,wordCount:c.wordCount,qualityScore:c.qualityScore,contentPreview:o.substring(0,100)+"..."}),chrome.runtime.sendMessage({action:"saveContent",data:c},g=>{console.log("üíæ Content saved to background:",g)}),chrome.runtime.sendMessage({action:"summarize",data:{title:c.title,description:c.content}},g=>{console.log("üì§ Sent to background:",g)}),c}getPageType(t){const e=new URL(t).hostname.toLowerCase();return e.includes("youtube.com")||e.includes("youtu.be")?"youtube":e.includes("medium.com")||e.includes("substack.com")||e.includes("dev.to")||e.includes("hackernoon.com")||t.includes("/blog/")||t.includes("/article/")||t.includes("/post/")?"article":"webpage"}getTitle(){let t="";if(this.getPageType(window.location.href)==="youtube"){const e=["h1.ytd-video-primary-info-renderer","h1.title",".watch-main-col h1","#eow-title"];for(const n of e){const o=document.querySelector(n);if(o&&o.textContent.trim()){t=o.textContent.trim();break}}}if(!t){const e=document.querySelector("h1");e&&e.textContent.trim()&&(t=e.textContent.trim())}return(!t||t.length<10)&&(t=document.title),t=this.cleanTitle(t),t}cleanTitle(t){const e=[" - YouTube"," | Medium"," - Dev.to"," | Hacker News"," - Stack Overflow"," - GitHub"];for(const n of e)if(t.endsWith(n)){t=t.slice(0,-n.length);break}return t.trim()}async getYouTubeContent(){console.log("Attempting to extract YouTube content...");const t=await this.getYouTubeTranscript();if(t&&t.length>50)return console.log("‚úÖ Found transcript:",t.length,"characters"),t;const e=this.getYouTubeDescription();return e&&e.length>20?(console.log("‚úÖ Found description:",e.length,"characters"),e):(console.log("‚ö†Ô∏è Using title as fallback"),this.getTitle())}getYouTubeDescription(){const t=["#description-text",".ytd-video-secondary-info-renderer #description","#watch-description-text",".content.style-scope.ytd-video-secondary-info-renderer","#meta-contents #description"];for(const e of t){const n=document.querySelector(e);if(n&&n.textContent.trim())return n.textContent.trim()}return""}async getYouTubeTranscript(){try{console.log("üîç Looking for transcript...");const t=this.findTranscriptButton();if(t){console.log("üìù Found transcript button, clicking..."),t.click(),await this.sleep(2e3);const n=this.extractTranscriptText();if(n)return n}const e=this.extractTranscriptText();return e?(console.log("üìù Found existing transcript"),e):(console.log("‚ùå No transcript found"),"")}catch(t){return console.log("‚ùå Transcript extraction error:",t.message),""}}findTranscriptButton(){const t=['button[aria-label*="transcript" i]','button[aria-label*="Show transcript" i]','button[title*="transcript" i]','[role="button"]:contains("transcript")','.ytp-menuitem[role="menuitem"]:contains("transcript")'];for(const n of t)if(n.includes(":contains")){const o=document.querySelectorAll(n.split(":contains")[0]);for(const r of o)if(r.textContent.toLowerCase().includes("transcript"))return r}else{const o=document.querySelector(n);if(o)return o}const e=document.querySelectorAll('button, [role="button"]');for(const n of e){const o=n.textContent.toLowerCase(),r=(n.getAttribute("aria-label")||"").toLowerCase();if(o.includes("transcript")||r.includes("transcript"))return n}return null}extractTranscriptText(){const t=[".ytd-transcript-segment-renderer",".transcript-item",'[data-testid="transcript-segment"]',".cue-group-start-offset"];for(const e of t){const n=document.querySelectorAll(e);if(n.length>0){const o=Array.from(n).map(r=>{let s=r.textContent.trim();return s=s.replace(/^\d{1,2}:\d{2}\s*/,""),s}).filter(r=>r.length>0);if(o.length>0)return o.join(" ")}}return""}sleep(t){return new Promise(e=>setTimeout(e,t))}getArticleContent(){const t=["article",'[role="main"]',".post-content",".entry-content",".article-content",".content","main","#content"];for(const e of t){const n=document.querySelector(e);if(n){const o=this.cleanContent(n);if(o.length>100)return o}}return this.cleanContent(document.body)}cleanContent(t){const e=t.cloneNode(!0);["script","style","noscript","nav","header","footer",".ad",".ads",".advertisement",".social-share",".share-buttons",".comments",".comment-section",".sidebar",".widget",".related-posts",".recommended",".newsletter",".subscription",'[class*="ad-"]','[id*="ad-"]'].forEach(r=>{e.querySelectorAll(r).forEach(c=>c.remove())});let o=e.textContent||"";return o=o.replace(/\s+/g," ").replace(/\n+/g,`
`).trim(),o}countWords(t){return t?t.trim().split(/\s+/).filter(e=>e.length>0).length:0}calculateQualityScore(t,e,n){let o=1;if(t>50&&(o+=1),t>100&&(o+=1),t>300&&(o+=1),t>500&&(o+=1),t>1e3&&(o+=1),t>2e3&&(o+=1),e.length>20&&e.length<100&&(o+=1),n==="youtube"){t>200&&(o+=1);const r=["tutorial","how to","explained","guide","learn"],s=e.toLowerCase();r.some(c=>s.includes(c))&&(o+=1)}return Math.min(o,10)}async extractTranscriptManually(){console.log("üîß Manual transcript extraction mode"),console.log('1. Look for "Show transcript" button and click it'),console.log("2. Wait a moment, then run: scraper.extractTranscriptText()");const t=document.querySelectorAll('[class*="transcript"], [aria-label*="transcript"]');return console.log("Found transcript-related elements:",t.length),t.forEach((e,n)=>{console.log(`Element ${n}:`,e.className,e.tagName)}),"Manual extraction initiated - check console for instructions"}}const d=new f;typeof chrome<"u"&&chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener((l,t,e)=>{if(l.action==="extractContent")return console.log("Received extract content request"),d.extractContent().then(n=>{console.log("Sending extracted content:",n),e({success:!0,content:n})}).catch(n=>{console.error("Extraction error:",n),e({success:!1,error:n.message})}),!0});let a=0,u=document.visibilityState==="visible",i=u?Date.now():null;const p=15*1e3;let m=!1;document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?(u=!0,i=Date.now(),console.log("‚è≥ Tab active again. Resuming timer...")):(u=!1,i&&(a+=Date.now()-i,console.log(`‚è∏Ô∏è Tab inactive. Active time so far: ${Math.floor(a/1e3)} sec`)))}),window.scraper=d,setInterval(async()=>{if(u&&!m){const l=Date.now();i&&(a+=l-i,i=l);const t=Math.floor(a/1e3);if(console.log(`‚è±Ô∏è Active time on page: ${t} seconds`),a>=p){console.log("‚úÖ Required active time reached! Extracting content...");const e=await d.extractContent();e&&(console.log("üéØ Content extracted after active time:",e),window.extractedContent=e,m=!0)}}},5e3),function(){let t=location.href;new MutationObserver(()=>{const n=location.href;n!==t&&(console.log("üîÑ YouTube SPA navigation detected:",n),t=n,a=0,m=!1,i=document.visibilityState==="visible"?Date.now():null,console.log("‚è≥ Waiting 15s after SPA navigation..."))}).observe(document.body,{childList:!0,subtree:!0}),console.log("üéØ YouTube SPA navigation observer activated")}()}
